[![Gitter](https://badges.gitter.im/Join%20Chat.svg)](https://gitter.im/aq1/WillBeams?utm_source=badge&utm_medium=badge&utm_campaign=pr-badge)

#Сбор webm

##Scraper
Скрипт, собирающий webm видео с одного сайта.

###Запуск
* Работает только на __питоне третьей версии__
* Скрипт использует стандартную библиотеку, ничего устанавливать не надо
* Все параметры прописаны в коде, поэтому запускается скрипт просто `python scraper.py`

###Код
Вроде код не очень сложный, но все равно лучше чтобы было объяснение.
Скрипт представляет из себя многопоточное приложение. Есть класс `MainWorker`, который запускает треды и обновляет каталоги (что может быть не очень правильно, если вспомнить о принципе единственной обязанности).


Класс `Searcher` ищет вебм в тредах, а класс `Downloader` скачивает файлы и отправляет их в функцию, которую получает как параметр `callback` метода `work`. Также он записывает логи. Каждый экземпляр этих классов запускается в отдельном треде и работает со своим HTTP соединением.

Эти классы унаследованы от абстрактного класса `Connection`, который предоставляет интерфейс для работы с сетью. Теоретически, если во время получения ресурса происходит ошибка, класс должен переподключиться и попробовать заново получить ответ.

Классы `Catalog` и `Thread` работают непосредственно с сайтом. `Catalog` получает собственно каталог и возвращает список тредов. Класс `Thread` Ищет webm-файлы в треде и возвращает их список. Также, он запоминает последний номер поста и поэтому не добавляет уже найденные файлы. Оба класса получают информацию с помощью функции fetch_tool, которая передается при вызове метода, отвечающего за поиск.

Класс `Logger` блокирует очередь, в которую были записаны логи и сбрасывает их на диск. Частота сброса контролируется полем _wait_time.


##Сохранение видео в модель django

Скрипт `save_to_django_model` наследуется от класса `Downloader` и переопределяет его методы. В методе `_download` проходит проверка на существование webm в модели (проверка проходит по md5). Если такое видео уже есть, его рейтинг увеличивается на 1 и webm не скачивается. Иначе, вебм добавляется в модель и на диск. В методе `save` проверяется еще раз, есть ли такое видео, потому что вроде бы другой тред может записать вебм до этого (не уверен точно, но частенько появлялась ошибка про нарушении unique в этом месте).

##Остальные скрипты

###check_for_duplicates
Проверяет лог на дубликаты webm. Сделан для проверки работы scrapper'а.

###delete_all_webms
Здесь все понятно, удаляет все вебм из модели. __Использую с умом__.


##Предложения и помощь.
Работа и архитектура приложения может показаться неправильной, это нормально. Приветствуется любая помощь и участие. 
